<script>
if (L.Browser.android) {
  var drag = false;
  var basemap = L.Mapzen.BasemapStyles.BubbleWrap
}else{
  var drag = true;
  var basemap = L.Mapzen.BasemapStyles.WalkaboutNoLabels
  }

var overviewmap,
  tangramLayer,
  x = false,
  key = L.Mapzen.apiKey = "mapzen-btYeCLJ",
  labels = L.Mapzen.BasemapStyles.Walkabout;
function buildMap() {
  overviewmap = new L.Mapzen.map('largemap', {
    dragging: drag,
    scrollWheelZoom: false,
    zoomControl: false,
    tangramOptions: {
      scene: basemap
    }
  });
  /*why did I have to look through source code to find this??*/
  overviewmap.on('tangramloaded', function(e) {
    tangramLayer = e.tangramLayer;
  });
  var latlng = [39.098,-83.047];
  overviewmap.setView(latlng, 9);
  var geocoder = L.Mapzen.geocoder(key, {
    layers: ["locality", "street"],
    expanded: false,
    markers: false
  });
  /*geocoder.addTo(map);*/
  var newZoom = L.control.zoom();
  var explore = document.getElementById('explore');

  $.getJSON("/trails/data/ovrdc_trails_web.geojson", function(data) {
      console.log('done loading trail data')
    })
    .done(function(data) {
      var roadTrails = new L.geoJson(data, {
        filter: function(feature) {
          if (feature.properties.Status == 'Existing') {
            return true
          }
        },
        style: {
          color: '#3c763d',
          weight: 8,
          opacity: 1,
        },
        onEachFeature: function(feature, trail) {
          var p = feature.properties;
          var popup = '<h4>Name: ' + p.Name +
          '</h4>Type:' + p.maptype +
          '<hr /><br />Subtitle: ' + p.subtitle +
          '<br />Length: ' + Number(p.length).toFixed(4) + 'mi' +
          '<br />Popup: ' + p.popup +
          '<br />Notes: ' + p.Notes;
          trail.bindPopup(popup);
        }
      }).addTo(overviewmap);
    })
    .fail(function() {
      console.log('error loading trail data')
    });

/*  omnivore.geojson('//www.ovrdc.org/apps/assets/data/trails/bikeways/OVRDC_Bikeways.geojson', null, roadTrails);

  omnivore.geojson('//www.ovrdc.org/apps/assets/data/trails/bikeways/Gravel_Grinding_101_ridewithgps.geojson', null, roadTrails);

  omnivore.geojson('//www.ovrdc.org/apps/assets/data/trails/bikeways/Ridgetop_Ramble_ridewithgps.geojson', null, roadTrails);*/


  explore.addEventListener('click', function() {
    if (!overviewmap.isFullscreen()) {
      overviewmap.toggleFullscreen();
      x = true;
      if (!L.Browser.android) {tangramLayer.scene.load(L.Mapzen.BasemapStyles.Walkabout);}
      newZoom.addTo(overviewmap);
      geocoder.addTo(overviewmap);
      if (overviewmap.hasLayer(roadTrails)) {
        overviewmap.removeLayer(roadTrails);
        setTimeout(function() {
          overviewmap.addLayer(roadTrails)
        }, 200);
      }
      overviewmap.scrollWheelZoom.enable();
      overviewmap.dragging.enable();
    }
  });
  overviewmap.on('fullscreenchange', function () {
    if (!overviewmap.isFullscreen() && x == true) {
      overviewmap.invalidateSize();
      overviewmap.removeControl(newZoom);
      overviewmap.removeControl(geocoder);
      if (!L.Browser.android) {tangramLayer.scene.load(L.Mapzen.BasemapStyles.WalkaboutNoLabels);}
      overviewmap.scrollWheelZoom.disable();
      overviewmap.dragging.disable();
      x = false;
    }
  });
}
window.onload = function() {
  buildMap();
}
</script>
